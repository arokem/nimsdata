<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nimsdata.nimspfile &mdash; NIMSData  documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="NIMSData  documentation" href="../../index.html" />
    <link rel="up" title="nimsdata" href="../nimsdata.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">NIMSData  documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../nimsdata.html" accesskey="U">nimsdata</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for nimsdata.nimspfile</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># @author:  Gunnar Schaefer</span>
<span class="c">#           Kevin S Hahn</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">NIMSPFile</span>
<span class="sd">=========</span>

<span class="sd">This module provides functions, classes and errors for reading for</span>
<span class="sd">minimally parsing a pfile.  Additional modules can be used to</span>
<span class="sd">full parse the pfiles.</span>

<span class="sd">NIMSPfile provides parsing and conversion for GE MR Raw files, affectionattely</span>
<span class="sd">referred to as &#39;PFiles&#39;.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">cStringIO</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">nimsmrdata</span>
<span class="kn">import</span> <span class="nn">tempdir</span> <span class="kn">as</span> <span class="nn">tempfile</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;nimspfile&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="unpack_uid"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.unpack_uid">[docs]</a><span class="k">def</span> <span class="nf">unpack_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert packed PFile UID to standard DICOM UID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uid : str</span>
<span class="sd">        packed PFile UID as a string</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uid : str</span>
<span class="sd">        unpacked PFile UID as string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span> <span class="k">else</span> <span class="s">&#39;.&#39;</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">uid</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="is_gzip"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.is_gzip">[docs]</a><span class="k">def</span> <span class="nf">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert packed PFile UID to standard DICOM UID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uid : str</span>
<span class="sd">        packed PFile UID as a string</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uid : str</span>
<span class="sd">        unpacked PFile UID as string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x1f\x8b</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compressed</span>

</div>
<div class="viewcode-block" id="uncompress"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.uncompress">[docs]</a><span class="k">def</span> <span class="nf">uncompress</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uncompress the contents of a tgz, or gz, into a specified tempdir.</span>

<span class="sd">    This function might be totally useless.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="c"># The following with pigz is ~4x faster than the python code above (with gzip, it&#39;s about 2.5x faster)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/usr/bin/pigz&#39;</span><span class="p">):</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;pigz -d -c </span><span class="si">%s</span><span class="s"> &gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">newpath</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/usr/bin/gzip&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/bin/gzip&#39;</span><span class="p">):</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;gzip -d -c </span><span class="si">%s</span><span class="s"> &gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">newpath</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzfile</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">gzfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newpath</span>

</div>
<div class="viewcode-block" id="get_version"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.get_version">[docs]</a><span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the pfile version of the file at filepath.</span>

<span class="sd">    An NIMSPFileError exception will be raised if the file is not a valid PFile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        filepath of file to check</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    version : str</span>
<span class="sd">        PFile version number of file at filepath</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NIMSPFileError : Exception</span>
<span class="sd">        error if the file is not a valid PFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>

    <span class="n">version_bytes</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">34</span><span class="p">);</span> <span class="n">logo</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;10s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;10s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x00\x00\xc0</span><span class="s">A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">24</span>
    <span class="k">elif</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;V</span><span class="se">\x0e\xa0</span><span class="s">A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">23</span>
    <span class="k">elif</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;J</span><span class="se">\x0c\xa0</span><span class="s">A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="k">elif</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x00\x00</span><span class="s">0A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; is not a valid PFile or of an unsupported version&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logo</span> <span class="o">!=</span> <span class="s">&#39;GE_MED_NMR&#39;</span> <span class="ow">and</span> <span class="n">logo</span> <span class="o">!=</span> <span class="s">&#39;INVALIDNMR&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; is not a valid PFile&#39;</span><span class="p">)</span>
    <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">version</span>

</div>
<div class="viewcode-block" id="NIMSPFileError"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFileError">[docs]</a><span class="k">class</span> <span class="nc">NIMSPFileError</span><span class="p">(</span><span class="n">nimsmrdata</span><span class="o">.</span><span class="n">NIMSMRDataError</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="NIMSPFile"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile">[docs]</a><span class="k">class</span> <span class="nc">NIMSPFile</span><span class="p">(</span><span class="n">nimsmrdata</span><span class="o">.</span><span class="n">NIMSMRReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read pfile data and/or header.</span>

<span class="sd">    This class reads the data and/or header from a pfile, runs k-space reconstruction,</span>
<span class="sd">    and generates a NIfTI object, including header information.</span>

<span class="sd">    NIMSPFile object can handle several different input types</span>
<span class="sd">    .tgz of directory containing Pfile, auxillary files such as ref.dat, vrgf.dat and tensor.dat</span>
<span class="sd">    .gz of single pfile</span>

<span class="sd">    the old way is no longer supported.</span>
<span class="sd">    Pfile.gz + _Pfile.7_ref.dat + _PFile.7._vrgf.dat _PFile.7_refscan.7, _P02048.7_param.dat</span>

<span class="sd">    NOTE: does nimspfile.NIMSPFile need to be backward compatible with nimsraw.NIMSPFile?</span>

<span class="sd">    Example:</span>
<span class="sd">        import pfile</span>
<span class="sd">        pf = pfile.PFile(filename=&#39;P56832.7&#39;)</span>
<span class="sd">        pf.to_nii(outbase=&#39;P56832.7&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filetype</span> <span class="o">=</span> <span class="s">u&#39;pfile&#39;</span>
    <span class="n">parse_priority</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">load_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">full_parse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NIMSPFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">load_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_parse</span> <span class="o">=</span> <span class="bp">False</span>                                 <span class="c"># indicates if this reader has &#39;full_parsed&#39; its file</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;parsing pfile </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;full_parse = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">full_parse</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;load_data = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">load_data</span><span class="p">)</span>
        <span class="c"># self.filepath set by nimsdata.NIMSData.__init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>      <span class="c"># discard the file extension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_localizer</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># determine the format</span>
        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="c"># tgz; find json with a [&#39;header&#39;] section</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;tgz&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">isreg</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_hdr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">bson</span><span class="o">.</span><span class="n">json_util</span><span class="o">.</span><span class="n">object_hook</span><span class="p">)[</span><span class="s">&#39;header&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c"># header section does not exist</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">; header section does not exist&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c"># json file does not exist</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">; not a json file&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_min_parse_tgz&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pfile_version&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;exam_no&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;exam_uid&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;patient_id&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;series_no&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;series_desc&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;series_uid&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;timestmap&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;prescribed_duration&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;psd_name&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;no json file with header section found. bailing&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># .7 or .7.gz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_full_parse</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">if</span> <span class="n">full_parse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_parse</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_status</span> <span class="o">=</span> <span class="s">&#39;pending&#39;</span>

        <span class="k">if</span> <span class="n">load_data</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_min_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a minimum required set of metadata from a Pfile fileobj.</span>

<span class="sd">        Can only parse Pxxxxx.7 and Pxxxxx.7.gz files, not tgz.  Does not load a self._hdr object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path of file to be parsed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;min_parse&#39;</span><span class="p">)</span>

        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">216</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_user0</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">240</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_user6</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">244</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_user7</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">914</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">ileaves</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">22</span><span class="p">]:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">143516</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">145622</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">145762</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">145875</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148396</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148834</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148972</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">]:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144248</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144409</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144240</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144401</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">61576</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">61966</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62127</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62710</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62786</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62899</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65024</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65328</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65374</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">,</span> <span class="n">flleobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">infer_psd_type</span><span class="p">(</span><span class="s">&#39;GE MEDICAL SYSTEMS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_user0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_user6</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ileaves</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_user7</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_full_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;work on .7.gz and .7.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;full_parse&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;Cannot Full Parse a tgz, need to load all data first. bailing.&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pfile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;pfile.pfile</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="nb">globals</span><span class="p">()),</span> <span class="s">&#39;pfile</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">No Valid PFile parser for v</span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span> <span class="o">=</span> <span class="n">pfile</span><span class="o">.</span><span class="n">POOL_HEADER</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;no pfile read&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm_data</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">ex_no</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">study_uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patidff</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_no</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_desc</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">series_uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">scanactno</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psdname</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psd_iname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span> <span class="o">=</span> <span class="s">&#39;P</span><span class="si">%05d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">run_int</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_firstname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subj_lastname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_subject_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patnameff</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_dob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_subject_dob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">dateofbirth</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_sex</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;male&#39;</span><span class="p">,</span> <span class="s">&#39;female&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patsex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patsex</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c"># HOShims don&#39;t have self._hdr.image.im_datetime</span>
                <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_date</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
                <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_time</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span>  <span class="c"># GE&#39;s epoch begins in 1900</span>

            <span class="c"># expose study date, study time, acquisition date, acquisition time</span>
            <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_date</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
            <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_time</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%4d%02d%02d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%02d%02d%02d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span><span class="p">,</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span><span class="p">,</span> <span class="s">&#39;%H%M%S&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ti</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">te</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tr</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c"># tr in seconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flip_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mr_flip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pixel_bandwidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">bw</span>
            <span class="c"># Note: the freq/phase dir isn&#39;t meaningful for spiral trajectories.</span>
            <span class="c"># GE numbers the dims 1,2, so freq_dir==1 is the first dim. We&#39;ll use</span>
            <span class="c"># the convention where first dim = 0, second dim = 1, etc. for phase_encode.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">freq_dir</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mt_offset_hz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">offsetfreq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">slquant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_averages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">averages</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nechoes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">receive_coil_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">cname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_receivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">dab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop_rcv</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">dab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_rcv</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">operator_new</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">prtcl</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">hospname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">ex_sysid</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_type</span> <span class="o">=</span> <span class="s">&#39;GE MEDICAL SYSTEMS DISCOVERY MR750&#39;</span>    <span class="c"># FIXME: don&#39;t hardcode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_type</span> <span class="o">=</span> <span class="bp">None</span>                                <span class="c"># hope this doesn&#39;t break anything...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dim_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dim_Y</span><span class="p">]</span>  <span class="c"># imatrix_Y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dfov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dfov_rect</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psd_iname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span>
            <span class="c"># Some sequences (e.g., muxepi) acuire more timepoints that will be available in the resulting data file.</span>
            <span class="c"># The following will indicate how many to expect in the final image.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deltaTE</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_data</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Compute the voxel size rather than use image.pixsize_X/Y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">slthick</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">scanspacing</span><span class="p">]</span>
            <span class="n">image_tlhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tlhc_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tlhc_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tlhc_S</span><span class="p">])</span>
            <span class="n">image_trhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">trhc_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">trhc_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">trhc_S</span><span class="p">])</span>
            <span class="n">image_brhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brhc_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brhc_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brhc_S</span><span class="p">])</span>

            <span class="c"># psd-specific params get set here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">infer_psd_type</span><span class="p">(</span><span class="s">&#39;GE MEDICAL SYSTEMS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user0</span><span class="p">)</span>    <span class="c"># not in self._hdr.rec.nframes for sprt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deltaTE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user15</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_spacing</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_data</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># spiral is always a square encode based on the frequency encode direction (size_x)</span>
                <span class="c"># Atsushi also likes to round up to the next higher power of 2.</span>
                <span class="c"># self.size_x = int(pow(2,ceil(log2(pf.size_x))))</span>
                <span class="c"># The rec.im_size field seems to have the correct reconned image size, but</span>
                <span class="c"># this isn&#39;t guaranteed to be correct, as Atsushi&#39;s recon does whatever it</span>
                <span class="c"># damn well pleases. Maybe we could add a check to ninfer the image size,</span>
                <span class="c"># assuming it&#39;s square?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">im_size</span>
                <span class="c"># self.mm_per_vox[0:2] = [self.fov[0] / self.size[0]] * 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
                <span class="c"># first 6 are ref scans, so ignore those. Also, two acquired timepoints are used</span>
                <span class="c"># to generate each reconned time point.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nechoes</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user6</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user7</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_spacing_mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">ileaves</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">ileaves</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span>
                <span class="c"># TODO: adjust the image.tlhc... fields to match the correct geometry.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;mrs&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">scanspacing</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roileny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilenx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilenz</span><span class="p">]</span>
                <span class="n">image_tlhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilocx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilocy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilocz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
                <span class="n">image_trhc</span> <span class="o">=</span> <span class="n">image_tlhc</span> <span class="o">-</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
                <span class="n">image_brhc</span> <span class="o">=</span> <span class="n">image_trhc</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">]</span>
            <span class="c"># Tread carefully! Most of the stuff down here depends on various fields being corrected in the</span>
            <span class="c"># sequence-specific set of hacks just above. So, move things with care!</span>

            <span class="c"># Note: the following is true for single-shot planar acquisitions (EPI and 1-shot spiral).</span>
            <span class="c"># For multishot sequences, we need to multiply by the # of shots. And for non-planar aquisitions,</span>
            <span class="c"># we&#39;d need to multiply by the # of phase encodes (accounting for any acceleration factors).</span>
            <span class="c"># Even for planar sequences, this will be wrong (under-estimate) in case of cardiac-gating.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span>
            <span class="c"># The actual duration can only be computed after the data are loaded. Settled for rx duration for now.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effective_echo_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">effechospace</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode_undersample</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">ileaves</span>
            <span class="c"># TODO: Set this correctly! (it&#39;s in the dicom at (0x0043, 0x1083))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_encode_undersample</span> <span class="o">=</span> <span class="mf">1.</span>          <span class="c"># FIXME</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_matrix_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_matrix_y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">rc_xres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">rc_yres</span><span class="p">]</span>
            <span class="c"># Diffusion params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">numdifdirs</span>
            <span class="c"># You might think that the b-valuei for diffusion scans would be stored in self._hdr.image.b_value.</span>
            <span class="c"># But alas, this is GE. Apparently, that var stores the b-value of the just the first image, which is</span>
            <span class="c"># usually a non-dwi. So, we had to modify the PSD and stick the b-value into an rhuser CV. Sigh.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user22</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="c"># if bit 4 of rhtype(int16) is set, then fractional NEX (i.e., partial ky acquisition) was used.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_ky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caipi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user13</span>   <span class="c"># true: CAIPIRINHA-type acquisition; false: Direct aliasing of simultaneous slices.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_blip_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user14</span>   <span class="c"># Starting index of the kz blips. 0~(mux-1) correspond to -kmax~kmax.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_blip_inc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user15</span>   <span class="c"># Increment of the kz blip index for adjacent acquired ky lines.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user17</span>   <span class="c"># MICA bit-reverse?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
            <span class="n">lr_diff</span> <span class="o">=</span> <span class="n">image_trhc</span> <span class="o">-</span> <span class="n">image_tlhc</span>
            <span class="n">si_diff</span> <span class="o">=</span> <span class="n">image_trhc</span> <span class="o">-</span> <span class="n">image_brhc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lr_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">si_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">row_cosines</span> <span class="o">=</span>  <span class="n">lr_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lr_diff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lr_diff</span><span class="p">))</span>
                <span class="n">col_cosines</span> <span class="o">=</span> <span class="o">-</span><span class="n">si_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">si_diff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">si_diff</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_cosines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">col_cosines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">SLICE_ORDER_UNKNOWN</span>
            <span class="c"># FIXME: check that this is correct.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_sortorder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">SLICE_ORDER_SEQ_INC</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_sortorder</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">SLICE_ORDER_ALT_INC</span>
            <span class="n">slice_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">norm_R</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">norm_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">norm_S</span><span class="p">])</span>
            <span class="c"># This is either the first slice tlhc (image_tlhc) or the last slice tlhc. How to decide?</span>
            <span class="c"># And is it related to wheather I have to negate the slice_norm?</span>
            <span class="c"># Tuned this empirically by comparing spiral and EPI data with the same Rx.</span>
            <span class="c"># Everything seems reasonable, except the test for axial orientation (start_ras==S|I).</span>
            <span class="c"># I have no idea why I need that! But the flipping only seems necessary for axials, not</span>
            <span class="c"># coronals or the few obliques I&#39;ve tested.</span>
            <span class="c"># FIXME: haven&#39;t tested sagittals!</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_ras</span> <span class="o">==</span> <span class="s">&#39;S&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_ras</span> <span class="o">==</span> <span class="s">&#39;I&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_loc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">end_loc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reverse_slice_order</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">slice_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_loc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">end_loc</span><span class="p">)</span>
                <span class="n">image_position</span> <span class="o">=</span> <span class="n">image_tlhc</span> <span class="o">-</span> <span class="n">slice_norm</span> <span class="o">*</span> <span class="n">slice_fov</span>
                <span class="c"># FIXME: since we are reversing the slice order here, should we change the slice_order field below?</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_position</span> <span class="o">=</span> <span class="n">image_tlhc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reverse_slice_order</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image_position</span> <span class="o">=</span> <span class="n">image_position</span> <span class="o">-</span> <span class="n">slice_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_spacing_mm</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

            <span class="c"># origin = image_position * np.array([-1, -1, 1])</span>
            <span class="c"># Fix the half-voxel offset. Apparently, the p-file convention specifies coords at the</span>
            <span class="c"># corner of a voxel. But DICOM/NIFTI convention is the voxel center. So offset by a half-voxel.</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">image_position</span> <span class="o">+</span> <span class="p">(</span><span class="n">row_cosines</span><span class="o">+</span><span class="n">col_cosines</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="c"># The DICOM standard defines these two unit vectors in an LPS coordinate frame, but we&#39;ll</span>
            <span class="c"># need RAS (+x is right, +y is anterior, +z is superior) for NIFTI. So, we compute them</span>
            <span class="c"># such that self.row_cosines points to the right and self.col_cosines points up.</span>
            <span class="n">row_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">row_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">col_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">col_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;the data appear to be diffusion-weighted, but image.b_value is 0!&#39;</span><span class="p">)</span>
            <span class="c"># The bvals/bvecs will get set later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvals</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_rotation</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">compute_rotation</span><span class="p">(</span><span class="n">row_cosines</span><span class="p">,</span> <span class="n">col_cosines</span><span class="p">,</span> <span class="n">slice_norm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qto_xyz</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">build_affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_scan_type_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aux_files</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">full_parse</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="NIMSPFile.canonical_filename"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.canonical_filename">[docs]</a>    <span class="k">def</span> <span class="nf">canonical_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="NIMSPFile.priority"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.priority">[docs]</a>    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>   <span class="c"># return 1 if we can recon, else -1</span>
</div>
<div class="viewcode-block" id="NIMSPFile.get_bvecs_bvals"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.get_bvecs_bvals">[docs]</a>    <span class="k">def</span> <span class="nf">get_bvecs_bvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve tensor file from within tgz archive.</span>

<span class="sd">        Tensor file, like other supplementary files, will be located within a tgz</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: have this identify tensor files from WITHIn a tgz</span>
        <span class="c"># and then save results to self.bvecs and self.bvals</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;collecting tensor info&#39;</span><span class="p">)</span>

        <span class="n">tensor_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="o">+</span><span class="s">&#39;_tensor.dat&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">extract_file</span><span class="p">(</span><span class="n">tensor_file</span><span class="p">)</span>      <span class="c"># identify the tensor file by name</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">; tensor file not found&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">ndirs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="o">+</span><span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="n">bvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">series_uid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;tensor file UID does not match PFile UID!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ndirs</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="o">!=</span> <span class="n">bvecs</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;tensor file numdirs does not match PFile header numdirs!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bvecs</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bvals</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># FIXME: assumes that all the non-dwi images are acquired first.</span>
                <span class="n">num_nondwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span>
                <span class="n">bvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_nondwi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span><span class="p">)))</span>
                <span class="n">bvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">num_nondwi</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">bvecs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bvecs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bvals</span> <span class="o">=</span> <span class="n">nimsmrdata</span><span class="o">.</span><span class="n">adjust_bvecs</span><span class="p">(</span><span class="n">bvecs</span><span class="p">,</span> <span class="n">bvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_rotation</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="NIMSPFile.recon_func"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.recon_func">[docs]</a>    <span class="k">def</span> <span class="nf">recon_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_spirec</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_mux_epi</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;mrs&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_mrs</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;hoshim&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_hoshim</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_basic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">prep_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># FIXME: the following is a hack to get mux_epi2 SE-IR scans to recon properly. There *is* a more generic solution...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">==</span> <span class="s">&#39;mux_epi2&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="c"># Mux scan without internal calibration-- request other mux scans be handed to convert</span>
            <span class="c"># to see if we can find a suitable calibration scan.</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;psd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">aux_data</span>

<div class="viewcode-block" id="NIMSPFile.load_data"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_virtual_coils</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span> <span class="o">=</span> <span class="n">num_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="c"># first need to know what type of file it is...</span>
        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;load_data, tgz&#39;</span><span class="p">)</span>
            <span class="c"># this tempdir will be used both for untaring the tgz, and</span>
            <span class="c"># for placing the temporary sl000.mat intermediate files</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dirpath</span><span class="p">:</span>
                <span class="c"># extract everything into tarfile</span>
                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="n">archive</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">temp_dirpath</span><span class="p">)</span>

                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_full_parse</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pfile_path</span> <span class="o">=</span> <span class="n">fpath</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;no pfile found?&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

                <span class="c"># find calibration files, if any</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cal_ref_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span> <span class="o">+</span> <span class="s">&#39;.7_ref.dat&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cal_vrgf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span> <span class="o">+</span> <span class="s">&#39;.7_vrgf.dat&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cal_ref_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cal_ref_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>           <span class="c"># set to empty, bc bob does it</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cal_vrgf_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cal_vrgf_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>          <span class="c"># set to empty, bc bob does it</span>

                <span class="c"># find dti tensor files, if any</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_bvecs_bvals</span><span class="p">()</span>      <span class="c"># needs to know where to look</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;running recon&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">num_jobs</span><span class="o">=</span><span class="n">num_jobs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;Recon not implemented for this type of data&#39;</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;closing tempdir </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">temp_dirpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;load_data, .7 or .7.gz&#39;</span><span class="p">)</span>
            <span class="c"># handle .7 or .7.gz</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_parse</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_full_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="c"># handle lone P file</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;running recon&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="o">=</span><span class="n">num_jobs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;Recon not implemented for this type of data&#39;</span><span class="p">)</span>

        <span class="c"># common ground stuff</span>
        <span class="c"># in some cases, more than one file is supposed to be output.</span>
        <span class="c"># how to deal wih datasets that have both self.data and self.fm_data?</span>
        <span class="c"># nimsnifti can only write a single file at a time.</span>
        <span class="c"># TODO: pfile needs to be updated to return data in dictionary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_slice_order</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fm_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm_data</span><span class="p">[:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c"># Uncomment to save spiral in/out</span>
                <span class="c"># nimsnifti.NIMSNifti.write(self, self.imagedata[:,:,:,:,0], outbase + &#39;_in&#39;)</span>
                <span class="c"># nimsnifti.NIMSNifti.write(self, self.imagedata[:,:,:,:,1], outbase + &#39;_out&#39;)</span>
                <span class="c"># FIXME: Do a more robust test for spiralio!</span>
                <span class="c"># Assume spiralio, so do a weighted average of the two echos.</span>
                <span class="c"># FIXME: should do a quick motion correction here</span>
                <span class="n">w_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">w_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">inout_sum</span> <span class="o">=</span> <span class="n">w_in</span> <span class="o">+</span> <span class="n">w_out</span>
                <span class="n">w_in</span> <span class="o">=</span> <span class="n">w_in</span> <span class="o">/</span> <span class="n">inout_sum</span>
                <span class="n">w_out</span> <span class="o">=</span> <span class="n">w_out</span> <span class="o">/</span> <span class="n">inout_sum</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">avg</span><span class="p">[:,:,:,</span><span class="n">tp</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_in</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:,</span><span class="n">tp</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w_out</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:,</span><span class="n">tp</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">avg</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;writing spiral IO&#39;</span><span class="p">)</span>
                <span class="c"># result = (&#39;nifti&#39;, nimsnifti.NIMSNifti.write(self, avg, outbase))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;writing spiral&#39;</span><span class="p">)</span>
                <span class="c"># result = (&#39;nifti&#39;, nimsnifti.NIMSNifti.write(self, self.data, outbase))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;writing fieldmaps&#39;</span><span class="p">)</span>
                <span class="c"># nimsnifti.NIMSNifti.write(self, self.fm_data, outbase + &#39;_B0&#39;)</span>
</div>
<div class="viewcode-block" id="NIMSPFile.prep_convert"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.prep_convert">[docs]</a>    <span class="k">def</span> <span class="nf">prep_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># possibly move this elsewhere.... maybe entirely into the processor</span>
        <span class="c"># processors calls this very early, after &quot;min_parse&quot;</span>
        <span class="c"># must occur after _min or _full_parse, which set the psd_type</span>
        <span class="c"># self.psd_type=&#39;muxepi&#39;</span>
        <span class="c"># self.num_mux_cal_cycle = 1</span>
        <span class="c"># self.psd_name = &#39;mux_epi2&#39;</span>
        <span class="c"># FIXME: the following is a hack to get mux_epi2 SE-IR scans to recon properly. There *is* a more generic solution...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">==</span> <span class="s">&#39;mux_epi2&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="c"># Mux scan without internal calibration-- request other mux scans be handed to convert</span>
            <span class="c"># to see if we can find a suitable calibration scan.</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;psd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">aux_data</span>
</div>
<div class="viewcode-block" id="NIMSPFile.load_imagedata_from_file"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.load_imagedata_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_imagedata_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load raw image data from a file and do some sanity checking on num slices, matrix size, etc.&quot;&quot;&quot;</span>
        <span class="c"># TODO: confirm that the voxel reordering is necessary. Maybe lean on the recon folks to standardize their voxel order?</span>
        <span class="kn">import</span> <span class="nn">scipy.io</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s">&#39;d_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">slice_locs</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s">&#39;sl_loc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">mat</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">])</span>
            <span class="n">imagedata</span><span class="p">[:,:,</span><span class="n">slice_locs</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;MIP_res&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s">&#39;MIP_res&#39;</span><span class="p">])</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
        <span class="k">if</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">imagedata</span>
</div>
<div class="viewcode-block" id="NIMSPFile.update_imagedata"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.update_imagedata">[docs]</a>    <span class="k">def</span> <span class="nf">update_imagedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagedata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imagedata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Image matrix discrepancy. Fixing the header, assuming imagedata is correct...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Image slice count discrepancy. Fixing the header, assuming imagedata is correct...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Image time frame discrepancy (header=</span><span class="si">%d</span><span class="s">, array=</span><span class="si">%d</span><span class="s">). Fixing the header, assuming imagedata is correct...&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="c"># FIXME: maybe need self.num_echos?</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_hoshim"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.recon_hoshim">[docs]</a>    <span class="k">def</span> <span class="nf">recon_hoshim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Cannot recon HO SHIM data&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_basic"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.recon_basic">[docs]</a>    <span class="k">def</span> <span class="nf">recon_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Cannot recon BASIC data&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_spirec"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.recon_spirec">[docs]</a>    <span class="k">def</span> <span class="nf">recon_spirec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do spiral image reconstruction and populate self.imagedata.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dirpath</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed</span><span class="p">:</span>
                <span class="n">pfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfile_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzfile</span><span class="p">:</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">gzfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pfile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span>
            <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="s">&#39;recon&#39;</span><span class="p">)</span>
            <span class="n">recon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;spiral_recon/spirec&#39;</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">recon_path</span> <span class="o">+</span> <span class="s">&#39; -l --rotate -90 --magfile --savefmap2 --b0navigator -r </span><span class="si">%s</span><span class="s"> -t </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pfile_path</span><span class="p">,</span> <span class="s">&#39;recon&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">))</span>  <span class="c"># run spirec to generate .mag and fieldmap files</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.mag_float&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.B0freq2&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.B0freq2&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fm_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.B0freq2&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="c"># TODO: this function needs to be re-assessed.  Is it even useful?  Pfiles that have associated aux files</span>
    <span class="c"># will always have their aux files inside the tgz with the Pfile....</span></div>
<div class="viewcode-block" id="NIMSPFile.find_mux_cal_file"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.find_mux_cal_file">[docs]</a>    <span class="k">def</span> <span class="nf">find_mux_cal_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;find mux cal&#39;</span><span class="p">)</span>
        <span class="n">cal_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_files</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">pf</span> <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">NIMSPFile</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_files</span><span class="p">]</span> <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_bands</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">pf</span> <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">NIMSPFile</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_files</span><span class="p">]</span> <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">cal_file</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">series_num_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">series_no</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">series_num_diff</span><span class="p">))</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">series_num_diff</span><span class="p">)</span>
                <span class="c"># there may be more than one. We prefer the prior scan:</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">series_num_diff</span><span class="p">[</span><span class="n">closest</span><span class="p">])</span><span class="o">==</span><span class="n">series_num_diff</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cal_file</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">closest</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cal_compressed</span> <span class="o">=</span> <span class="n">is_compressed</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span>
            <span class="n">cal_basename</span> <span class="o">=</span> <span class="n">cal_file</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">cal_compressed</span> <span class="k">else</span> <span class="n">cal_file</span>
            <span class="n">cal_ref_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cal_basename</span><span class="p">),</span> <span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cal_basename</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.7_ref.dat&#39;</span><span class="p">)</span>
            <span class="n">cal_vrgf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cal_basename</span><span class="p">),</span> <span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cal_basename</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.7_vrgf.dat&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cal_compressed</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">cal_ref_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">cal_vrgf_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="c"># Make sure we return an empty string when none is found.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cal_file</span><span class="p">:</span>
            <span class="n">cal_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">cal_file</span><span class="p">,</span><span class="n">cal_ref_file</span><span class="p">,</span><span class="n">cal_vrgf_file</span><span class="p">,</span><span class="n">cal_compressed</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_mux_epi"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.recon_mux_epi">[docs]</a>    <span class="k">def</span> <span class="nf">recon_mux_epi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=</span><span class="p">[],</span> <span class="n">octave_bin</span><span class="o">=</span><span class="s">&#39;octave&#39;</span><span class="p">):</span>
        <span class="n">start_sec</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start_sec</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Do mux_epi image reconstruction and populate self.data.&quot;&quot;&quot;</span>
        <span class="n">ref_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="o">+</span><span class="s">&#39;_ref.dat&#39;</span><span class="p">)</span>
        <span class="n">vrgf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="o">+</span><span class="s">&#39;_vrgf.dat&#39;</span><span class="p">)</span>
        <span class="c"># See if external calibration data files are needed:</span>
        <span class="n">cal_file</span><span class="p">,</span><span class="n">cal_ref_file</span><span class="p">,</span><span class="n">cal_vrgf_file</span><span class="p">,</span><span class="n">cal_compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mux_cal_file</span><span class="p">()</span>
        <span class="c"># The dat files might be missing or empty if the vendor recon was disabled. If so, try to use the cal dat file.</span>
        <span class="c"># FIXME: if the p-file is not compressed, the cal dat file will not be used! We should refactor the recon</span>
        <span class="c"># code so that the dat files are always explicitly specified.</span>
        <span class="c"># if not os.path.isfile(ref_file) or os.path.getsize(ref_file)&lt;64:</span>
        <span class="c">#     if cal_ref_file:</span>
        <span class="c">#         ref_file = cal_ref_file</span>
        <span class="c">#     else:</span>
        <span class="c">#         raise NIMSPFileError(&#39;ref.dat file not found&#39;)</span>
        <span class="c"># if not os.path.isfile(vrgf_file) or os.path.getsize(vrgf_file)&lt;64:</span>
        <span class="c">#     if cal_vrgf_file:</span>
        <span class="c">#         vrgf_file = cal_vrgf_file</span>
        <span class="c">#     else:</span>
        <span class="c">#         raise NIMSPFileError(&#39;vrgf.dat file not found&#39;)</span>
        <span class="n">ref_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_ref_file</span>
        <span class="n">vrgf_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_vrgf_file</span>

        <span class="c"># HACK to force SENSE recon for caipi data</span>
        <span class="c">#sense_recon = 1 if &#39;CAIPI&#39; in self.series_desc else 0</span>
        <span class="n">sense_recon</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fermi_filt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">notch_thresh</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># already have a tempdir open...</span>
        <span class="c"># with tempfile.TemporaryDirectory(dir=tempdir) as temp_dirpath:</span>
        <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">pfile_path</span> <span class="o">=</span> <span class="n">filepath</span>
            <span class="n">temp_dirpath</span> <span class="o">=</span> <span class="n">tempdir</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Running </span><span class="si">%d</span><span class="s"> v-coil mux recon on </span><span class="si">%s</span><span class="s"> in tempdir </span><span class="si">%s</span><span class="s"> with </span><span class="si">%d</span><span class="s"> jobs (sense=</span><span class="si">%d</span><span class="s">, fermi=</span><span class="si">%d</span><span class="s">, notch=</span><span class="si">%f</span><span class="s">).&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="p">,</span> <span class="n">sense_recon</span><span class="p">,</span> <span class="n">fermi_filt</span><span class="p">,</span> <span class="n">notch_thresh</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cal_file</span><span class="o">!=</span><span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Using calibration file: </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">cal_file</span><span class="p">)</span>
            <span class="c"># if self.compressed:</span>
            <span class="c">#     shutil.copy(ref_file, os.path.join(temp_dirpath, os.path.basename(ref_file)))</span>
            <span class="c">#     shutil.copy(vrgf_file, os.path.join(temp_dirpath, os.path.basename(vrgf_file)))</span>
            <span class="c">#     pfile_path = uncompress(self.filepath, temp_dirpath)</span>

            <span class="c"># if cal_file and cal_compressed:</span>
            <span class="c">#     shutil.copy(cal_ref_file, os.path.join(temp_dirpath, os.path.basename(cal_ref_file)))</span>
            <span class="c">#     shutil.copy(vrgf_file, os.path.join(temp_dirpath, os.path.basename(cal_vrgf_file)))</span>
            <span class="c">#     cal_file = uncompress(cal_file, temp_dirpath)</span>
            <span class="n">recon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;mux_epi_recon&#39;</span><span class="p">))</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="s">&#39;sl&#39;</span><span class="p">)</span>

            <span class="c"># Spawn the desired number of subprocesses until all slices have been spawned</span>
            <span class="n">mux_recon_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">slice_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">slice_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">:</span>
                <span class="n">num_running_jobs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="o">==</span><span class="bp">None</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">mux_recon_jobs</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">num_running_jobs</span> <span class="o">&lt;</span> <span class="n">num_jobs</span><span class="p">:</span>
                    <span class="c"># Recon each slice separately. Note the slice_num+1 to deal with matlab&#39;s 1-indexing.</span>
                    <span class="c"># Use &#39;str&#39; on timepoints so that an empty array will produce &#39;[]&#39;</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> --no-window-system -p </span><span class="si">%s</span><span class="s"> --eval </span><span class="se">\&#39;</span><span class="s">mux_epi_main(&quot;</span><span class="si">%s</span><span class="s">&quot;, &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%03d</span><span class="s">.mat&quot;, &quot;</span><span class="si">%s</span><span class="s">&quot;, </span><span class="si">%d</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%d</span><span class="s">, 0, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">);</span><span class="se">\&#39;</span><span class="s">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">octave_bin</span><span class="p">,</span> <span class="n">recon_path</span><span class="p">,</span> <span class="n">pfile_path</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">,</span> <span class="n">slice_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoints</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sense_recon</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fermi_filt</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">notch_thresh</span><span class="p">)))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                    <span class="n">mux_recon_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)))</span>
                    <span class="n">slice_num</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">))</span>

            <span class="c"># Now wait for all the jobs to finish</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">mux_recon_jobs</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c"># Load the first slice to initialize the image array</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_imagedata_from_file</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%03d</span><span class="s">.mat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">slice_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">):</span>
                <span class="n">new_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_imagedata_from_file</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%03d</span><span class="s">.mat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">))</span>
                <span class="c"># Allow for a partial last timepoint. This sometimes happens when the user aborts.</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">t</span><span class="p">]</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_imagedata</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_sec</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Mux recon of </span><span class="si">%s</span><span class="s"> with </span><span class="si">%d</span><span class="s"> v-coils finished in </span><span class="si">%0.2f</span><span class="s"> minutes using </span><span class="si">%d</span><span class="s"> jobs.&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span><span class="p">,</span>  <span class="n">elapsed</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_jobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_mrs"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.recon_mrs">[docs]</a>    <span class="k">def</span> <span class="nf">recon_mrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">num_jobs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently just loads raw spectro data into self.imagedata so that we can save it in a nifti.&quot;&quot;&quot;</span>
        <span class="c"># Reorder the data to be in [frame, num_frames, slices, passes (repeats), echos, coils]</span>
        <span class="c"># This roughly complies with the nifti standard of x,y,z,time,[then whatever].</span>
        <span class="c"># Note that the &quot;frame&quot; is the line of k-space and thus the FID timeseries.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawdata</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="NIMSPFile.get_rawdata"><a class="viewcode-back" href="../../nimsdata.html#nimsdata.nimspfile.NIMSPFile.get_rawdata">[docs]</a>    <span class="k">def</span> <span class="nf">get_rawdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coils</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">echos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return a chunck of data from the p-file.</span>

<span class="sd">        Specify the slices, timepoints, coils, and echos that you want.</span>
<span class="sd">        None means you get all of them. The default of all Nones will</span>
<span class="sd">        return all data.</span>
<span class="sd">        (based on https://github.com/cni/MRS/blob/master/MRS/files.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nframes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">hnover</span>
        <span class="n">n_echos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nechoes</span>
        <span class="n">n_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nslices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span>
        <span class="n">n_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_receivers</span>
        <span class="n">n_passes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span>
        <span class="n">frame_sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">frame_size</span>

        <span class="k">if</span> <span class="n">passes</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">passes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_passes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coils</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">coils</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_coils</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slices</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">slices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">echos</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">echos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_echos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frames</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">)</span>

        <span class="c"># Size (in bytes) of each sample:</span>
        <span class="n">ptsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">point_size</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">][</span><span class="n">ptsize</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c"># This is double the size as above, because the data is complex:</span>
        <span class="n">frame_bytes</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ptsize</span> <span class="o">*</span> <span class="n">frame_sz</span>

        <span class="n">echosz</span> <span class="o">=</span> <span class="n">frame_bytes</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n_frames</span><span class="p">)</span>
        <span class="n">slicesz</span> <span class="o">=</span> <span class="n">echosz</span> <span class="o">*</span> <span class="n">n_echos</span>
        <span class="n">coilsz</span> <span class="o">=</span> <span class="n">slicesz</span> <span class="o">*</span> <span class="n">n_slices</span>
        <span class="n">passsz</span> <span class="o">=</span> <span class="n">coilsz</span> <span class="o">*</span> <span class="n">n_coils</span>

        <span class="c"># Byte-offset to get to the data:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">off_data</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">frame_sz</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">echos</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coils</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">passes</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pi</span><span class="p">,</span><span class="n">passidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">passes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ci</span><span class="p">,</span><span class="n">coilidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coils</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">si</span><span class="p">,</span><span class="n">sliceidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ei</span><span class="p">,</span><span class="n">echoidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">echos</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fi</span><span class="p">,</span><span class="n">frameidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
                            <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">passidx</span><span class="o">*</span><span class="n">passsz</span> <span class="o">+</span> <span class="n">coilidx</span><span class="o">*</span><span class="n">coilsz</span> <span class="o">+</span> <span class="n">sliceidx</span><span class="o">*</span><span class="n">slicesz</span> <span class="o">+</span> <span class="n">echoidx</span><span class="o">*</span><span class="n">echosz</span> <span class="o">+</span> <span class="p">(</span><span class="n">frameidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">frame_bytes</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
                            <span class="c"># Unfortunately, numpy fromfile doesn&#39;t like gzip file objects. But we can</span>
                            <span class="c"># safely load each chunk into RAM, since frame_sz is never very big.</span>
                            <span class="c">#dr = np.fromfile(fp, data_type, frame_sz * 2)</span>
                            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">frame_bytes</span><span class="p">),</span> <span class="n">data_type</span><span class="p">)</span>
                            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">data</span><span class="p">[:,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">]</span> <span class="o">=</span> <span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1j</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">NIMSData  documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../nimsdata.html" >nimsdata</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>